---
title: "Analysis of Munc on Bassoon Data"
output: html_notebook
---


This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup}
    knitr::opts_knit$set(root.dir = normalizePath("../../Desktop/Kittel_Lab/macro_output/")) 
```

```{r}
getwd()
```


# Data
## Load data

```{r}
filenames <- Sys.glob("*.bassoon.csv")  # get a list of bassoon results
BassoonBlobs <- lapply(filenames, function(.file){
  dat<-read.csv(.file, header=T)
  dat$filename<-as.character(.file)
  dat    # return the dataframe
})
BassoonBlobs <- do.call(rbind, BassoonBlobs) # combine into a single dataframe
```

Parsing filenames

```{r}
# E followed by a integer number of any length, followed by a _ and then anything
BassoonBlobs$experiment <- sub("E(\\d*)_.*", "\\1", BassoonBlobs$filename)
# anything followed by _ then a string without _, followed by _ and then again anything
BassoonBlobs$treatment <- sub(".*_([^_]+)_.*", "\\1", BassoonBlobs$filename)
# last number before the dot = anything followed by a number of any length, followed by a . and anything
BassoonBlobs$dish <- sub(".*_(\\d*)\\..*", "\\1", BassoonBlobs$filename)
```

Munc counts are integers

```{r}
BassoonBlobs$Munc_count <- as.integer(BassoonBlobs$Munc_count)
```

Removing Munc count of background

```{r}
BassoonBlobs<-BassoonBlobs[!(BassoonBlobs$Bassoon_id==0),]
```

```{r}
BassoonBlobs$Marker <- ifelse(BassoonBlobs$experiment %in% c(6,7,9), "VGAT", "VGluT1")
```


# Descriptive statistics

```{r}
library(lattice)
```


## Effect of TTX

```{r}
histogram(~Munc_count|experiment+treatment,auto.key=TRUE,data=BassoonBlobs)
histogram(~Munc_count|experiment+treatment,auto.key=TRUE,data=BassoonBlobs, breaks=-1:15)

```
## Only active zones belonging to VGAT or VGluT1 marker

```{r}
histogram(~Munc_count|experiment+treatment,auto.key=TRUE,data=subset(BassoonBlobs,Marker_overlap=1), breaks=-1:15)

```

## Depending on synapse type

Instead of plotting for experiments, pooling all experiments with same Marker.

```{r}
histogram(~Munc_count|Marker+treatment,auto.key=TRUE, data=subset(BassoonBlobs, Marker_overlap=1), breaks=-1:15)
```
### Restricted to experiments with Sakamoto Munc antibody

```{r}
histogram(~Munc_count|Marker+treatment,auto.key=TRUE,data=subset(BassoonBlobs, as.numeric(experiment)>2 & Marker_overlap==1 ), breaks=-1:15)
```
### Restricted to last experiment 

```{r}
histogram(~Munc_count|Marker+treatment,auto.key=TRUE,data=subset(BassoonBlobs, as.numeric(experiment)>7 & Marker_overlap==1 ), breaks=-1:15)
```

# Modelling of Munc per Bassoon

Clearly, the count of munc spots per basson blob does not follow a normal distribution and we cannot use standard Linear Regression models like ANOVA to fit the data. Generalized Linear Models are models in which response variables follow a distribution other than the normal distribution. Specifically, we will use a Poisson Regression models, which are best used for modeling events where the outcomes are counts. 

## Effect of TTX

```{r}
model = glm(Munc_count ~ treatment + experiment, data=BassoonBlobs, family = poisson(link = "log"))
summary(model)
```

The Residual deviance is larger than degrees of freedom. This indicates **overdisperion**. In general, poisson distribution the variance is equal to the mean. We can test for the overdispersion by comparing the expected to the modeled residuals using this approxiate: https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#overdispersion.

```{r}
overdisp_fun <- function(model) {
rdf <- df.residual(model)
rp <- residuals(model,type="pearson")
Pearson.chisq <- sum(rp^2)
prat <- Pearson.chisq/rdf
pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
```


```{r}
overdisp_fun(model)
```

Overdispersion means that the variance is much greater than the mean. Our model is to simple to explain this excess variance in the data. The general idea is to add another predictor to our model and which we do not really care for: a *random* effect. This could be the variation introduced by choosing a field of view for taking the image. This is in contrast to predictor we varied on purpose: a *fixed* effect. The modelling of these **mixed effect models** can be done by the package **lme4**.

```{r}
library(lme4)
model = glmer(Munc_count ~ treatment + experiment + (1|dish), data=BassoonBlobs, family = poisson(link = "log"))
summary(model)
```



### Excitatory synapses 

```{r}
model = glmer(Munc_count ~ treatment + experiment + (1|dish), data=subset(BassoonBlobs, Marker_overlap==1 & Marker=="VGluT1"), family = poisson(link = "log"))
summary(model)
```

Post hoc Tukeys test

```{r}
library(multcomp)
```


```{r}
G = glht(model, mcp(treatment = "Tukey", experiment = "Tukey"))
summary(G)
confint(G)
```

#### Restricted to last experiment

```{r}
model = glmer(Munc_count ~ treatment + (1|dish), data=subset(BassoonBlobs, experiment>7 & Marker_overlap==1 & Marker=="VGluT1"), family = poisson(link = "log"))
summary(model)
```



### Inhibitory synapses 

```{r}
model = glmer(Munc_count ~ treatment + experiment + (1|dish), data=subset(BassoonBlobs, Marker_overlap==1 & Marker=="VGAT"), family = poisson(link = "log"))
summary(model)
```

Post hoc Tukeys test

```{r}
G = glht(model, mcp(treatment = "Tukey", experiment = "Tukey"))
summary(G)
confint(G)
```



